{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tax-refund",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "binaryPropertyName": "data"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2352,
        1792
      ],
      "id": "39b982fc-87e5-4972-bea0-56049ef7ae17",
      "name": "Webhook",
      "webhookId": "3787ac93-c057-4b15-b59a-922a0ef15cbb"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        2640,
        1792
      ],
      "id": "55b49400-9399-4ad1-b08b-27c0dcd0142c",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prepare_body",
              "name": "gemini_body",
              "value": "={{ { contents: [ { parts: [ { text: 'Extract all data from this Israeli Form 106 (טופס 106) tax document and return ONLY valid JSON with these fields: tax_year, employee_name, employee_id, employer_name, employer_id, total_income, total_tax_paid, tax_credit_points, work_months. Use null for missing fields. Return ONLY the JSON object, no other text.\\n\\nDocument text:\\n' + ($json.extractedText || '') } ] } ] } }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3504,
        1792
      ],
      "id": "302ae099-4ece-4ae7-8c9d-600ac2a6355c",
      "name": "Prepare Gemini Body"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "extract_text",
              "name": "response_text",
              "value": "={{ $json.candidates?.[0]?.content?.parts?.[0]?.text || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4944,
        1792
      ],
      "id": "7c8f12cf-87c4-4a02-9216-3064a3788328",
      "name": "Extract Response Text"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "parse",
              "name": "data",
              "value": "={{ JSON.parse($json.output) }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5168,
        1792
      ],
      "id": "caeef999-7eaf-431d-8fc9-903b87f1f7cb",
      "name": "Parse JSON"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "response",
              "name": "response",
              "value": "={{ { status: 'success', data: $json.data, extracted_at: new Date().toISOString() } }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5392,
        1792
      ],
      "id": "00d6e47b-96da-4257-a834-48b675eccafb",
      "name": "Build Response"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        5536,
        1568
      ],
      "id": "e55cc80b-c4c6-4bc1-9b3f-59d5ec8a2f6e",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.gemini_body.contents[0].parts[0].text }} The form is here - {{ $('Extract from File').item.json.text }}\nYou receive the attached PDF for analysis.\n\nThis PDF is an Israeli yearly tax report for salaried income for tax year 2024, generated by the Israel Tax Authority personal area (\"מידע על הכנסות לשנת המס 2024\", Form 106 style).\n\nTasks:\n1. Read the document carefully.\n2. Extract, if possible:\n   - tax_year\n   - total_taxable_income (שדה 158/172 – הסך הכל בש\"ח)\n   - total_tax_withheld (שדה 042 – סך ניכויי מס)\n   - weighted_credit_points (מספר נקודות זיכוי משוקלל שניתנו במהלך השנה)\n   - total_credit_value_nis (סכום נקודות הזיכוי בשקלים)\n3. Using the system instructions, calculate:\n   - estimated gross_tax, net_tax, refund_estimated, and refund_direction.\n\nIf any of the key numeric fields (total_taxable_income, total_tax_withheld) cannot be read with high confidence, leave them as null in the JSON and add an explanation in notes.\n\nReturn only a single JSON object, in the exact schema described in the system prompt and nothing else.\n4. Leave refund _calc_without_ai key and value as is.\nAdd the key and value to the output response.\nThis value is a calculated refund value, without using AI, and should be added to the end responce JSON.\n{{ $json[\"refund _calc_without_ai\"] }}",
        "options": {
          "systemMessage": "You are a careful Israeli income tax assistant for salaried employees.\n\nYour task:\n1. Read an Israeli yearly Form 106 (or equivalent annual summary) provided as a PDF document.\n2. Extract, for a single tax year:\n   - tax_year\n   - total_taxable_income (in NIS, integer) – e.g. field 158/172\n   - total_tax_withheld (in NIS, integer) – e.g. field 042\n   - weighted_credit_points (number, e.g. 5.08)\n   - total_credit_value_nis (in NIS, integer) – if given explicitly\n3. Using the extracted data, calculate whether the employee overpaid or underpaid income tax for that year, and what is the estimated refund (or additional payment) amount.\n\nRules and assumptions:\n- The form is for Israel, salaried employee only (no business income, no capital gains, no special exemptions).\n- Work only for the year stated on the form (tax_year).\n- Treat Form 106 values as the ground truth; do NOT invent or \"guess\" missing values. If a value is unclear, say so explicitly.\n- If both weighted_credit_points and total_credit_value_nis are present, use total_credit_value_nis directly as the yearly credit amount.\n- If only weighted_credit_points is present, you may approximate yearly credit as:\n  yearly_credit = weighted_credit_points × 3,150 NIS\n  (this is a rough 2024-style approximation and should be clearly labeled as an estimate).\n- Income tax must be calculated using progressive annual tax brackets for Israel for the relevant year. If you are not certain of exact brackets for that year, use a reasonable approximation and clearly mark the result as an estimate.\n- Compute:\n  1) gross_tax = tax due before credits, based on progressive brackets\n  2) net_tax = max(gross_tax − yearly_credit, 0)\n  3) refund = total_tax_withheld − net_tax\n- Interpretation of refund:\n  - If refund > 0 → the employee overpaid and may be entitled to a refund.\n  - If refund ≈ 0 (|refund| < 100) → negligible difference.\n  - If refund < 0 → the employee underpaid and may owe additional tax of |refund|.\n- Be conservative: if any essential value (taxable income or tax withheld) is missing, do NOT perform the calculation. Instead, explain which fields are missing.\n\nOutput format:\nReturn a single JSON object with the following shape, and nothing else (no explanations outside the JSON):\n\n{\n  \"tax_year\": 2024,\n  \"total_taxable_income\": 202420,\n  \"total_tax_withheld\": 24509,\n  \"weighted_credit_points\": 5.08,\n  \"yearly_credit_used\": 15972,\n  \"gross_tax_estimated\": 0,\n  \"net_tax_estimated\": 0,\n  \"refund_estimated\": 0,\n  \"refund_direction\": \"refund\" | \"pay_more\" | \"none\",\n  \"notes\": [\n    \"short explanation string 1\",\n    \"short explanation string 2\"\n  ]\n}\n\nConventions:\n- All money amounts must be integers in NIS (no commas, no currency symbols).\n- refund_direction:\n  - \"refund\" if refund > 0\n  - \"pay_more\" if refund < 0\n  - \"none\" if |refund| < 100 or you decide it is negligible\n- In notes, clearly mention if tax brackets or credit values were approximated, and that this is an estimate and not formal tax advice.\n\nDo not return English text outside the JSON. The user will see the JSON and format it separately.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        4592,
        1792
      ],
      "id": "c679d54a-e0e6-4701-98a4-3ce77401a3f7",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-5-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        3680,
        2016
      ],
      "id": "96906b6d-0e0d-4c8b-9df9-a423381fe1b9",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "RUEQXcPgpxPfY7p4",
          "name": "n8n free OpenAI API credits"
        }
      }
    },
    {
      "parameters": {
        "operation": "sanitize",
        "text": "={{ $json.text }}",
        "guardrails": {
          "secretKeys": {
            "value": {
              "permissiveness": "balanced"
            }
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.guardrails",
      "typeVersion": 2,
      "position": [
        2864,
        1792
      ],
      "id": "2702efb9-c136-47e0-8824-c35c811117b5",
      "name": "Guardrails"
    },
    {
      "parameters": {
        "operation": "checkIfEvaluating"
      },
      "type": "n8n-nodes-base.evaluation",
      "typeVersion": 4.8,
      "position": [
        3072,
        1792
      ],
      "id": "7bc395be-1827-4a43-9cbd-15a493a89578",
      "name": "Evaluation"
    },
    {
      "parameters": {
        "source": "dataTable",
        "dataTableId": {
          "__rl": true,
          "value": "SPHZCSBKoZWkfIUf",
          "mode": "list",
          "cachedResultName": "tax",
          "cachedResultUrl": "/projects/qziqMrQ4h91ghFX0/datatables/SPHZCSBKoZWkfIUf"
        }
      },
      "id": "988f47ef-cd4a-4663-bebe-451c0a162a8a",
      "name": "When fetching a dataset row1",
      "type": "n8n-nodes-base.evaluationTrigger",
      "position": [
        2720,
        2208
      ],
      "typeVersion": 4.6
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "93f89095-7918-45ad-aa74-a0bbcf0d5788",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json.questions }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c1878073-94e6-4ded-9be2-9ffbdd626426",
      "name": "Match chat format",
      "type": "n8n-nodes-base.set",
      "position": [
        2944,
        2064
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "80508f4f-77ec-48ef-912e-295ac377bf33",
              "name": "total_income_raw",
              "value": "=={{ \n  (\n    ($json.guardrailsInput || '')\n      .split('\\n')\n      .find(line => line.includes('(158/172)')) \n      || ''\n  ).match(/(\\d[\\d,]*)\\s*$/)?.[1] || '' \n}}\n",
              "type": "string"
            },
            {
              "id": "1704fa4d-847e-4bc4-a6ab-1bb3e4759779",
              "name": "total_tax_paid_raw",
              "value": "=={{ $json.guardrailsInput.match(/סה''כ ניכויי מס\\s*\\)042\\(\\s*([\\d,]+)/)?.[1] || '' }}",
              "type": "string"
            },
            {
              "id": "0f95c67a-95e4-40aa-9a68-90c52b7137be",
              "name": "tax_credit_points_raw",
              "value": "=={{ $json.guardrailsInput.match(/מספר נקודות זיכוי משוקלל שניתנו במהלך השנה\\s*([\\d.]+)/)?.[1] || '' }}",
              "type": "string"
            },
            {
              "id": "bffef81c-3e83-42e2-bb8b-25be5f9ed939",
              "name": "yearly_credit_used_raw",
              "value": "=={{ $json.guardrailsInput.match(/סכום נקודות הזיכוי בשקלים\\s*([\\d,]+)/)?.[1] || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3712,
        1792
      ],
      "id": "4bd99059-fc22-4da6-805a-79ef6eb14538",
      "name": "Extract Numeric Fields (Regex)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2e0e3d20-e95a-418c-a6b0-beef966bb2b8",
              "name": "=total_income_clean",
              "value": "={{   ($json.total_income_raw || '')    .toString()    .replace('=', '')    .replace(/,/g, '')    .trim()}}",
              "type": "string"
            },
            {
              "id": "1dbb6941-a928-40be-b8c3-417701dc24dc",
              "name": "total_tax_paid_raw_clean",
              "value": "={{   ($json.total_tax_paid_raw || '')    .toString()    .replace('=', '')    .replace(/,/g, '')    .trim()}}",
              "type": "string"
            },
            {
              "id": "d533b90e-3dcc-4bb6-b6f9-f86bc9e1a9bc",
              "name": "yearly_credit_used_raw_clean",
              "value": "={{   ($json.yearly_credit_used_raw || '')    .toString()    .replace('=', '')    .replace(/,/g, '')    .trim()}}",
              "type": "string"
            },
            {
              "id": "8ee5f538-4c32-4334-b577-ca4763c69f40",
              "name": "tax_credit_points_raw_clean",
              "value": "={{   ($json.tax_credit_points_raw || '')    .toString()    .replace('=', '')    .replace(/,/g, '')    .trim()}}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3920,
        1792
      ],
      "id": "1702ec8c-c664-4d7a-8411-fbae498db365",
      "name": "Normalize Numeric Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c729cb12-9a0c-451a-a2a2-598ccdcc4bc3",
              "name": "=income_num",
              "value": "={{ Number($json.total_income_clean) }}",
              "type": "number"
            },
            {
              "id": "f173e1e4-a787-4062-98ff-3bbbafd64ccc",
              "name": "tax_paid_num",
              "value": "={{ Number($json.total_tax_paid_raw_clean) }}",
              "type": "number"
            },
            {
              "id": "87f34ac8-0b1e-4442-bc5b-5aec6331da10",
              "name": "credit_value_num",
              "value": "={{ Number($json.yearly_credit_used_raw_clean) }}",
              "type": "number"
            },
            {
              "id": "ad73d13d-0e4f-4dc8-8727-20664f220e32",
              "name": "credit_points_num",
              "value": "={{ Number($json.tax_credit_points_raw_clean) }}",
              "type": "number"
            },
            {
              "id": "48ba137f-0eee-4c0e-9bd6-e7176e6274ac",
              "name": "refund_amount",
              "value": "={{ \n  Number($json.total_tax_paid_raw_clean) \n  - \n  (33413 - Number($json.yearly_credit_used_raw_clean))\n}}\n",
              "type": "number"
            },
            {
              "id": "a25b8bc8-717b-43f3-ada4-ebd92e32bd57",
              "name": "refund_direction",
              "value": "={{    Number($json.total_tax_paid_raw_clean)      -    (33413 - Number($json.yearly_credit_used_raw_clean))    > 0     ? 'refund'     : (         Number($json.total_tax_paid_raw_clean)            -          (33413 - Number($json.yearly_credit_used_raw_clean))          < 0           ? 'pay'           : 'neutral'       ) }}",
              "type": "string"
            },
            {
              "id": "971e6c7e-6b53-4104-bf1f-19148445bfa2",
              "name": "gross_tax_num",
              "value": "={{ \n  (function () {\n    const income = Number($json.total_income_clean); // 202420 אצלך\n\n    // מדרגות מס 2024 (שנתי) – מקורב על בסיס טבלאות 2024\n    const brackets = [\n      { limit: 84120, rate: 0.10 },   // 0 – 84,120 ≈ 10% [web:30][web:33][web:37]\n      { limit: 120720, rate: 0.14 },   // 84,121 – 120,720 ≈ 14% [web:30][web:33][web:37]\n      { limit: 193800, rate: 0.20 },   // 120,721 – 193,800 ≈ 20% [web:30][web:33][web:37]\n      { limit: 247440, rate: 0.31 },   // 193,801 – 247,440 ≈ 31% [web:30][web:33][web:37]\n      { limit: 514920, rate: 0.35 },   // 247,441 – 514,920 ≈ 35% [web:30][web:33][web:37]\n      { limit: 663240, rate: 0.47 },   // 514,921 – 663,240 ≈ 47% [web:30][web:37]\n      { limit: Infinity, rate: 0.50 }, // מעל זה 50% [web:30][web:37]\n    ];\n\n    let remaining = income;\n    let previousLimit = 0;\n    let tax = 0;\n\n    for (let i = 0; i < brackets.length; i++) {\n      const b = brackets[i];\n      if (income > previousLimit) {\n        const taxableInBracket = Math.min(income, b.limit) - previousLimit;\n        tax += taxableInBracket * b.rate;\n        previousLimit = b.limit;\n      } else {\n        break;\n      }\n    }\n\n    return Math.round(tax); // מס ברוטו שנתי מוערך\n  })()\n}}\n",
              "type": "number"
            },
            {
              "id": "cb848f4c-09f5-4b3f-a8e4-3cd583ebf638",
              "name": "credit_value_calc",
              "value": "={{ Math.round(Number($json.tax_credit_points_raw_clean) * 2904) }}",
              "type": "number"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4128,
        1792
      ],
      "id": "5ae848ac-4838-4bb0-9e9d-335ba9cbf35a",
      "name": "Calculate Refund"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e52fd84c-39bf-4873-ace1-71dcf818222f",
              "name": "credit_value_num",
              "value": "={{ Number($json.credit_value_num) }}",
              "type": "number"
            },
            {
              "id": "c8fa4b16-1f76-447e-a31d-37b9f8e304f5",
              "name": "tax_paid_num",
              "value": "={{ $json.tax_paid_num}}",
              "type": "number"
            },
            {
              "id": "d952382b-b0d5-4f8c-ac0c-37365dc885fe",
              "name": "net_tax_num",
              "value": "={{ \n  Math.max(\n    Number($json.gross_tax_num) - Number($json.credit_value_num),\n    0\n  ) \n}}\n",
              "type": "number"
            },
            {
              "id": "f16a467d-c3a0-435c-8494-b1f62205be28",
              "name": "refund_amount",
              "value": "={{ \n  Number($json.tax_paid_num)\n  -\n  Math.max(\n    Number($json.gross_tax_num) - Number($json.credit_value_calc),\n    0\n  )\n}}\n",
              "type": "number"
            },
            {
              "id": "4c66e07f-a5f6-44d5-8894-384f0dabe737",
              "name": "refund_direction",
              "value": "={{    Number($json.refund_amount) > 0     ? 'refund'     : (Number($json.refund_amount) < 0 ? 'pay' : 'neutral') }}",
              "type": "string"
            },
            {
              "id": "059cd5be-8e1d-409a-9b6b-ad0c8f5ff2f1",
              "name": "refund _calc_without_ai",
              "value": "={{ \n  Number($json.tax_paid_num)\n  -\n  Math.max(\n    Number($json.gross_tax_num) - Number($json.credit_value_calc),\n    0\n  )\n}}\n",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4336,
        1792
      ],
      "id": "f07c3261-e8bb-48c4-a0a3-180147d5ed77",
      "name": "Edit Fields"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Guardrails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Gemini Body": {
      "main": [
        [
          {
            "node": "Extract Numeric Fields (Regex)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response Text": {
      "main": [
        [
          {
            "node": "Parse JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse JSON": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Extract Response Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Guardrails": {
      "main": [
        [
          {
            "node": "Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evaluation": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Gemini Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When fetching a dataset row1": {
      "main": [
        [
          {
            "node": "Match chat format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match chat format": {
      "main": [
        [
          {
            "node": "Prepare Gemini Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Numeric Fields (Regex)": {
      "main": [
        [
          {
            "node": "Normalize Numeric Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Numeric Fields": {
      "main": [
        [
          {
            "node": "Calculate Refund",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Refund": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "25138963674472896474fbf723543df2890b08be63d81d0e7e9e9b3b5084a997"
  }
}
